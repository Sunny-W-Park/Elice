## w7-220517-tue

### 게시판 CRUD - 게시글 작성
* post router 생성 -> posts/edit(pug template)으로 연결
```js
const { Router } = require('express')
const router = new Router();

// 게시글 작성(GET 요청)
router.get('/', (req, res, next) => {
    if (req.query.write) {      // query.write에 값이 들어올 경우
        res.render('posts/edit');       //views/posts/edit.pug 출력
        return;
    }
})

// POST 요청
router.post('/', async(req, res, next) => {        // async-await으로 비동기 처리
    const {title, content} = req.body;
    try {
        await Post.create({
            title,
            content,
        });
        res.redirect('/');      // 작성 후 자동으로 route path로
        // res.redirect('/posts/post.shortid');     // 작성 후 해당 게시글로
    } catch (err) {
        next(err);
    }
})

module.exports = router;
```

### 게시판 CRUD - 게시글 목록
```js
// 전체 목록(GET)
router.get('/', async(req, res, next) => {
    const posts = await Post.find({});
    res.render('posts/list', {posts});      //views/posts/list.pug 출력
})

// 특정 포스트(GET)
router.get('/:shortId', async(req, res, next) => {
    const {shortId} = req.params;
    const post = await Post.findOne({ shortId });
    if (!post) {
        next (newError('Post NotFound'))
        return
    }
    ...
    res.render('posts/view', {post})        // views/posts/view.pug 출력
})
``` 

### 게시글 CRUD - 게시글 수정
* html form은 PUT 메서드 지원x
```js
// 수정 요청 받기(GET)
router.get('/:shortId', async(req, res, next) => {
    if (req.query.edit) {
        res.render('posts/edit', {post})
    }
})

// 수정 요청 처리(POST): html form이 PUT을 지원하지 않기 때문에 POST로 처리
router.post('/:shortId', async(req, res, next) => {
    const {shortId} = req.params;
    const {title, content} = req.body;
    const post = await Post.findOneAndUpdate({shortId}, {title, content});
    if (!post) {
        next(new Error('Post NotFound'));
        return;
    } 
    res.redirect('/posts/${shortId}')
})
```

### 게시판 CRUD - 게시글 삭제
* html form은 DELETE 메서드 지원x
```js
// DELETE 요청 처리
const {Post} = require('./models');

router.delete('/:shortId', async(req, res, next) => {
    const {shortId} = req.params;
    try {
        await Post.delete({shortId});
        res.send('OK');
    } catch (err) {
        next(err);
    }
})
```
### 

### pagination: express.js + mongoose
```js
router.get(... => {
    const page = Number(req.query.page || 1)        // query는 문자열로 전달됨!!
    const perPage = Number(req.query.perPage || 10)
})

// MongoDB의 limit과 skip을 사용하여 구현
// limit: 검색 결과 수 제한
// skip: 검색 시 포함하지 않을 데이터 수
router.get(... => {
    const total = await Post
        .countDocument({});
    const posts = await Post.find({})
        .sort({ createAt: -1 })
        .skip(perPage * (page - 1))     // 앞에서부터 데이터 몇개를 생략할 것인가?
        .limit(perPage);
    const totalPage = Math.ceil(total / perPage);     
    // 게시글 수 / 페이지 당 게시글 수 = 총 페이지 수
})
```


